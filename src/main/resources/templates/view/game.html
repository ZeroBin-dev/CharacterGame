<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <th:block th:replace="~{common/head.html :: headFragment}"/>
</head>
<body class="game_body">
<div id="game-container">

  <!-- 타이틀 -->
  <h2 th:text="${info.title}"></h2>
  <h3 id="title"></h3>

  <!-- 문제갯수 선택 -->
  <div id="question-selection">
    <img class="menu-img" th:src="${info.menuImg}" th:alt="${info.title}" />
    <button class="question-button" onclick="startGame(10)">10문제</button>
    <button class="question-button" onclick="startGame(20)">20문제</button>
    <button class="question-button" onclick="startGame(50)">50문제</button>
    <button class="question-button" onclick="startDeathMatchMode()">데스매치 모드</button>
    <p style="color: red; font-size: 14px;">※ 데스매치 모드는 20문제 랜덤 출제, 한 문제당 20초 제한, 4개 이상 오답 시 게임 종료됩니다.</p>
    <button class="red-button" onclick="location.href='/'">다른 게임 하러 가기</button>
    <button class="blue-button" th:onclick="'location.href=\'/study/' + @{${info.menuId}} + '\''">공부하기</button>
  </div>

  <!-- 게임 -->
  <div id="game" style="display: none;">
    <h2 id="question-counter" style="display: none;">[0/0]</h2> <!-- 일반 모드에서는 숨김 -->
    <img id="question-image" src="" alt="캐릭터 이미지" onclick="imgZoomIn(event)">
    <p id="lives" style="font-size: 20px; display: none;"></p> <!-- 남은 목숨 표시 (초기에는 보이지 않음) -->
    <p style="color: gray; font-size: 14px;">※ 띄어쓰기는 없습니다.</p>
    <input class="game_input" type="text" id="answer-input" placeholder="정답을 입력하세요" autocomplete="off" onkeydown="handleKeyDown(event)">
    <button class="game_button" onclick="checkAnswer()" id="submit-answer">확인</button>
    <p id="feedback"></p>
    <p id="timer" style="font-size: 20px; display: none;"></p> <!-- 타이머 (초기에는 보이지 않음) -->
  </div>

  <!-- 게임 종료 -->
  <div id="results" style="display: none;">
    <h2>게임 종료</h2>
    <p id="score"></p>
    <button class="game_button" onclick="resetGame()">처음으로 돌아가기</button>
  </div>

  <!-- 실패 화면 -->
  <div id="fail-screen" style="display: none;">
    <h2>게임 실패</h2>
    <p>4회 이상 틀리셨습니다.</p>
    <button class="game_button" onclick="resetGame()">처음으로 돌아가기</button>
  </div>

  <!-- 성공 화면 -->
  <div id="success-screen" style="display: none;">
    <h2>게임 성공</h2>
    <p id="final-score"></p>
    <label for="player-name">이름을 입력하세요:</label>
    <input type="text" id="player-name">
    <button onclick="submitScore()">점수 제출</button>
    <button class="game_button" onclick="resetGame()">처음으로 돌아가기</button>
  </div>
</div>

<script th:inline="javascript">
  const questions = [[${list}]];
  let selectedQuestions = [];
  let currentQuestionIndex = 0;
  let correctCount = 0;
  let isDeathMatch = false; // 데스매치 모드 여부
  let wrongCount = 0;
  let lives = 3; // 초기 목숨 수
  let timerInterval;

  function startGame(questionCount) {
    isDeathMatch = false; // 일반 모드로 초기화
    selectedQuestions = questions.sort(() => 0.5 - Math.random()).slice(0, questionCount);
    document.getElementById('question-selection').style.display = 'none';
    document.getElementById('game').style.display = 'block';
    document.getElementById('title').textContent = `${questionCount}문제 모드 시작!`;
    currentQuestionIndex = 0; // 초기화
    correctCount = 0; // 초기화
    lives = 3; // 초기화
    document.getElementById('lives').style.display = 'none'; // 하트 숨김
    document.getElementById('timer').style.display = 'none'; // 타이머 숨김
    displayQuestion(); // 첫 질문 표시
  }

  function displayQuestion() {
    if (currentQuestionIndex < selectedQuestions.length) {
      const currentQuestion = selectedQuestions[currentQuestionIndex];
      document.getElementById('question-image').src = currentQuestion.imagePath;
      document.getElementById('answer-input').value = '';
      document.getElementById('answer-input').disabled = false;
      document.getElementById('answer-input').focus();

      // 일반 모드일 때 카운트 숨기기
      if (!isDeathMatch) {
        document.getElementById('question-counter').style.display = 'none'; // 카운트 숨기기
      } else {
        document.getElementById('question-counter').style.display = 'block'; // 카운트 보이기
        document.getElementById('question-counter').textContent = `[${currentQuestionIndex + 1}/${selectedQuestions.length}]`;
      }

      document.getElementById('feedback').textContent = ''; // 초기화
      document.getElementById('feedback').style.display = 'block';

      // 하트 표시
      if (isDeathMatch) {
        displayLives(); // 데스매치 모드일 때 하트 표시
        startTimer(); // 타이머 시작
      } else {
        document.getElementById('timer').style.display = 'none'; // 타이머 숨김
      }
    } else {
      endGame();
    }
  }

  function handleKeyDown(event) {
    if (event.key === 'Enter') {
      event.preventDefault(); // 기본 엔터 동작 방지
      const button = document.getElementById('submit-answer').textContent === "다음" ? nextQuestion : checkAnswer;
      button(); // 적절한 함수를 호출
    }
  }

  function checkAnswer() {
    const userAnswer = document.getElementById('answer-input').value.trim();
    const answer = selectedQuestions[currentQuestionIndex].correctAnswer;

    clearInterval(timerInterval); // 정답 확인 후 타이머 정지

    if (userAnswer.toLowerCase() === answer.toLowerCase()) {
      correctCount++;
      document.getElementById('feedback').textContent = "정답입니다!";
      document.getElementById('feedback').className = "correct";
    } else {
      document.getElementById('feedback').textContent = `오답입니다! 정답은 '${answer}'입니다.`;
      document.getElementById('feedback').className = "incorrect";
      wrongCount++;

      if (isDeathMatch) {
        lives--; // 데스매치 모드일 때만 목숨 감소
        displayLives(); // 남은 목숨 업데이트

        if (lives <= 0) {
          failGame(); // 목숨이 0이 되면 게임 종료
          return;
        }
      }
    }

    document.getElementById('submit-answer').textContent = "다음"; // 다음 문제 버튼으로 변경
    document.getElementById('submit-answer').onclick = nextQuestion; // 버튼 클릭 시 다음 문제로 이동
    document.getElementById('answer-input').disabled = true; // 입력 비활성화
  }

  // 남은 목숨 표시 함수
  function displayLives() {
    const livesDisplay = document.getElementById('lives');
    livesDisplay.textContent = `남은 목숨: ${'❤️'.repeat(lives)}`;
    livesDisplay.style.display = 'block'; // 하트를 표시
  }

  function startDeathMatchMode() {
    isDeathMatch = true;
    wrongCount = 0;
    selectedQuestions = questions.sort(() => 0.5 - Math.random()).slice(0, 20); // 20문제 랜덤 출제
    document.getElementById('question-selection').style.display = 'none';
    document.getElementById('game').style.display = 'block';
    document.getElementById('title').textContent = `데스매치 모드 시작!`;
    currentQuestionIndex = 0;
    correctCount = 0;
    lives = 3; // 데스매치 모드 초기화
    displayLives(); // 남은 목숨 표시
    startTimer(); // 타이머 시작
    displayQuestion();
  }


  function startTimer() {
    let timeLeft = 20; // 타이머 시간 설정

    // 타이머가 이미 실행 중이라면 종료
    if (timerInterval) {
      clearInterval(timerInterval);
    }

    // 새로운 타이머 시작
    timerInterval = setInterval(() => {
      if (timeLeft <= 0) {
        clearInterval(timerInterval); // 타이머 정지
        document.getElementById('feedback').textContent = "시간 초과!";
        document.getElementById('feedback').className = "incorrect";
        wrongCount++;

        if (isDeathMatch) {
          lives--; // 데스매치 모드일 때 목숨 감소
          displayLives(); // 남은 목숨 업데이트

          if (lives <= 0) {
            failGame(); // 목숨이 0이 되면 게임 종료
          }
        }
      } else {
        document.getElementById('timer').textContent = `남은 시간: ${timeLeft}초`;
        timeLeft--;
      }
    }, 1000); // 1초마다 실행
  }

  function nextQuestion() {
    clearInterval(timerInterval); // 이전 타이머 정지
    currentQuestionIndex++;
    displayQuestion();
  }

  function endGame() {
    document.getElementById('game').style.display = 'none';
    document.getElementById('results').style.display = 'block';
    document.getElementById('score').textContent = `맞힌 문제: ${correctCount} / ${selectedQuestions.length}`;
  }

  function failGame() {
    clearInterval(timerInterval); // 타이머 정지
    document.getElementById('game').style.display = 'none';
    document.getElementById('fail-screen').style.display = 'block';
  }

  function resetGame() {
    document.getElementById('results').style.display = 'none';
    document.getElementById('fail-screen').style.display = 'none';
    document.getElementById('success-screen').style.display = 'none';
    document.getElementById('question-selection').style.display = 'block';
    currentQuestionIndex = 0;
    correctCount = 0;
  }

  function submitScore() {
    const playerName = document.getElementById('player-name').value;
    // 여기에 점수 제출 로직 추가
    document.getElementById('success-screen').style.display = 'none';
    resetGame();
  }
</script>
</body>
</html>
